Instalation von Home Assistan in Dockercontainer innerhalb von RaspberryPiOs

Schritt 1 - Raspberry Pi OS Installieren

Raspberry Pi OS auf SD Karte Installieren via PiImager

Schritt 2 - Docker Installieren 

sudo apt-get update
sudo apt-get upgrade
sudo reboot

curl -fsSL https://get.docker.com -o docker-script.sh
sudo sh docker-script.sh

**bei fehler**
sudo dpkg --configure -a


sudo usermod -aG docker pi

**Validierung**
docker info


Schritt 3 - Home Assistant Container Installieren

**Verzeichnis für docker erstellen**
mkdir /home/pi/docker/homeassistant

docker run --init -d \
  --name homeassistant \
  --restart=unless-stopped \
  -v /etc/localtime:/etc/localtime:ro \
  -v /home/pi/docker/homeassistant:/config \
  --network=host \
  homeassistant/raspberrypi3-homeassistant:stable
  
Schritt 4 - MQTT server in Docker Container installieren

**Verzeichnis für Mqtt erstellen**
mkdir /home/pi/docker/mqtt

Schritt 5 - Zigbee2Mqtt Installieren

**Verzeichnis für Zigbee2Mqtt erstellen**
mkdir /home/pi/docker/zigbee2mqtt

docker run \
   -it \
   -v /home/pi/docker/zigbee2mqtt \		// Verzeichnis von Zigbee2Mqtt	
   --device=/dev/ttyACM0 \				// ort des Adapters
   -e TZ=Europe/Berlin \				// Zeitzone
   -v /run/udev:/run/udev:ro \			
   --privileged=true \
   koenkk/zigbee2mqtt  
   
**cc2531 identifizieren**

sudo lsusb -v

**Regel Konfigurieren idVendor = [] idProduct =[]**

echo "SUBSYSTEM==\"tty\", ATTRS{idVendor}==\"0451\", ATTRS{idProduct}==\"16a8\", SYMLINK+=\"cc2531\",  RUN+=\"/usr/local/bin/docker-setup-cc2531.sh\"" | sudo tee /etc/udev/rules.d/99-cc2531.rules
sudo udevadm control --reload-rules

**docker setup erstellen**

sudo nano /usr/local/bin/docker-setup-cc2531.sh

#!/bin/bash
 USBDEV=`readlink -f /dev/cc2531`
 read minor major < <(stat -c '%T %t' $USBDEV)
 if [[ -z $minor || -z $major ]]; then
     echo 'Device not found'
     exit
 fi
 dminor=$((0x${minor}))
 dmajor=$((0x${major}))
 CID=`docker ps -a --no-trunc | grep koenkk/zigbee2mqtt | head -1 |  awk '{print $1}'`
 if [[ -z $CID ]]; then
     echo 'CID not found'
     exit
 fi
 echo 'Setting permissions'
 echo "c $dmajor:$dminor rwm" > /sys/fs/cgroup/devices/docker/$CID/devices.allow
 
**Berechtigungen Erteilen**
 
sudo chmod 744 /usr/local/bin/docker-setup-cc2531.sh

**event listener erstellen**

sudo nano /usr/local/bin/docker-event-listener.sh

 #!/bin/bash
 docker events --filter 'event=start'| \
 while read line; do
     /usr/local/bin/docker-setup-cc2531.sh
 done
 
**Berechtigungen Erteilen**

sudo chmod 744 /usr/local/bin/docker-event-listener.sh

**listener service erstellen**

sudo nano /etc/systemd/system/docker-event-listener.service

[Unit]
 Description=Docker Event Listener for TI CC2531 device
 After=network.target
 StartLimitIntervalSec=0
 [Service]
 Type=simple
 Restart=always
 RestartSec=1
 User=root
 ExecStart=/bin/bash /usr/local/bin/docker-event-listener.sh

 [Install]
 WantedBy=multi-user.target
 
 **Berechtigungen Erteilen**

sudo chmod 744 /etc/systemd/system/docker-event-listener.service

**Deamon neuladen**
sudo systemctl daemon-reload

sudo systemctl start docker-event-listener.service
sudo systemctl status docker-event-listener.service
sudo systemctl enable docker-event-listener.service


##########################################################################
Quellen
##########################################################################
https://www.zigbee2mqtt.io/information/docker.html
https://www.home-assistant.io/installation/raspberrypi
https://rsw.io/how-to-install-docker-on-a-raspberry-pi/